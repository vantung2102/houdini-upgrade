// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

const readPkgTree = require('read-package-tree');
const fetch = require('node-fetch');

const npmjsCoordinates = ({ name, version }) =>
  'npm/npmjs/' + (name.includes('/') ? name : `-/${name}`) + `/${version}`;

module.exports = function noticeme(path, rpt = readPkgTree, http = fetch) {
  return new Promise((resolve, reject) => {
    rpt(path, function (err, { children }) {
      if (err) reject(err);

      const pkgJsonLicenses = new Map();
      const coordinates = children.map(({ package, children: more }) => {
        children.push(...more);
        const coordinate = npmjsCoordinates(package);

        // TODO: make use of these as fallback
        pkgJsonLicenses.set(coordinate, package.license);

        return coordinate;
      });

      http('https://api.clearlydefined.io/notices', {
        method: 'post',
        body: JSON.stringify({ coordinates }),
        headers: { 'Content-Type': 'application/json' },
      })
        .then(res => res.json())
        .then(json => resolve(json.content));
    });
  });
}